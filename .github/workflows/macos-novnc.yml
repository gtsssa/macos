name: macOS Real VNC
on: workflow_dispatch

jobs:
  deploy:
    runs-on: macos-14

    steps:
    - name: Install noVNC and enable screen sharing
      run: |
        # å®‰è£… noVNC ä¾èµ–
        brew install websockify
        
        # ä¸‹è½½ noVNC
        git clone https://github.com/novnc/noVNC.git ~/noVNC
        
        # å¯ç”¨å±å¹•å…±äº«ï¼ˆVNCï¼‰
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw asdf1234 \
          -restart -agent -privs -all
        
        echo "VNCæœåŠ¡å·²å¯ç”¨ï¼Œå¯†ç : asdf1234"

    - name: Start noVNC proxy
      run: |
        # å¯åŠ¨ websockify ä»£ç†
        websockify --web ~/noVNC 6080 localhost:5900 &
        sleep 5
        echo "noVNCä»£ç†å·²å¯åŠ¨: 6080ç«¯å£"

    - name: Setup Cloudflared tunnel
      run: |
        curl -L https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-darwin-arm64.tgz -o cloudflared.tgz
        tar -xzf cloudflared.tgz
        chmod +x cloudflared
        
        ./cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
        sleep 40
        
        echo "è®¿é—®URL:"
        grep -o 'https://[^ ]*\.trycloudflare\.com' tunnel.log | head -1 || echo "è¯·æŸ¥çœ‹ tunnel.log"

    - name: Run
      run: |
        echo "âœ… macOS noVNC æ¡Œé¢"
        echo "ğŸ”‘ VNCå¯†ç : asdf1234"
        timeout 6h tail -f tunnel.log
