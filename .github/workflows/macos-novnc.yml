name: macOS Simple noVNC
on: workflow_dispatch

jobs:
  deploy:
    runs-on: macos-14

    steps:
    - name: Download and setup noVNC
      run: |
        # ä¸‹è½½é¢„ç¼–è¯‘çš„ noVNC
        wget https://github.com/novnc/noVNC/archive/refs/tags/v1.4.0.tar.gz
        tar -xzf v1.4.0.tar.gz
        mv noVNC-1.4.0 ~/noVNC
        
        # ä¸‹è½½ websockify
        wget https://github.com/novnc/websockify/archive/refs/tags/v0.11.0.tar.gz
        tar -xzf v0.11.0.tar.gz
        mv websockify-0.11.0 ~/websockify
        
        echo "æ–‡ä»¶ä¸‹è½½å®Œæˆ"

    - name: Enable VNC and start proxy
      run: |
        # å¯ç”¨ macOS VNC
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw asdf1234 \
          -restart -agent -privs -all
        
        sleep 10
        
        # ç›´æ¥ä½¿ç”¨ python è¿è¡Œ websockify
        cd ~/websockify
        python3 websockify/websocketproxy.py --web ~/noVNC 6080 localhost:5900 &
        
        echo "æœåŠ¡å¯åŠ¨å®Œæˆ"

    - name: Start tunnel
      run: |
        curl -L https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-darwin-arm64.tgz -o cloudflared.tgz
        tar -xzf cloudflared.tgz
        chmod +x cloudflared
        
        ./cloudflared tunnel --url http://localhost:6080 2>&1 | tee tunnel.log &
        sleep 45

    - name: Display info
      run: |
        echo "âœ… macOS noVNC Desktop"
        echo "ğŸ”‘ å¯†ç : asdf1234"
        timeout 6h tail -f tunnel.log
