name: macOS noVNC
on: workflow_dispatch

jobs:
  deploy:
    runs-on: macos-14

    steps:
    - name: Setup noVNC properly
      run: |
        # ä¸‹è½½ noVNC
        wget https://github.com/novnc/noVNC/archive/refs/tags/v1.4.0.tar.gz
        tar -xzf v1.4.0.tar.gz
        mv noVNC-1.4.0 ~/noVNC
        
        # ä¸‹è½½ websockify å¹¶æ­£ç¡®å®‰è£…
        wget https://github.com/novnc/websockify/archive/refs/tags/v0.11.0.tar.gz
        tar -xzf v0.11.0.tar.gz
        cd websockify-0.11.0
        # å®‰è£…åˆ°ç”¨æˆ·ç›®å½•
        python3 -m pip install --user .
        cd ..
        
        echo "å®‰è£…å®Œæˆï¼Œwebsockify å·²å®‰è£…åˆ° Python åŒ…ç›®å½•"

    - name: Enable VNC and start proxy
      run: |
        # å¯ç”¨ macOS VNC
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw asdf1234 \
          -restart -agent -privs -all
        
        echo "ç­‰å¾…VNCæœåŠ¡å¯åŠ¨..."
        sleep 15
        
        # å¯åŠ¨ websockify - ä½¿ç”¨ç»å¯¹è·¯å¾„
        /Users/runner/.local/bin/websockify --web ~/noVNC 6080 localhost:5900 &
        
        sleep 5
        echo "æ£€æŸ¥è¿›ç¨‹:"
        ps aux | grep websockify | grep -v grep || echo "websockify æœªè¿è¡Œ"
        
        echo "æ£€æŸ¥ç«¯å£:"
        lsof -i :6080 || echo "ç«¯å£6080æœªç›‘å¬"

    - name: Start tunnel
      run: |
        curl -L https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-darwin-arm64.tgz -o cloudflared.tgz
        tar -xzf cloudflared.tgz
        chmod +x cloudflared
        
        ./cloudflared tunnel --url http://localhost:6080 2>&1 | tee tunnel.log &
        sleep 45
        
        echo "éš§é“ä¿¡æ¯:"
        tail -20 tunnel.log

    - name: Display info
      run: |
        echo "âœ… macOS noVNC Desktop"
        echo "ğŸ”‘ å¯†ç : asdf1234"
        echo ""
        echo "æœ¬åœ°æµ‹è¯•: curl http://localhost:6080 || echo 'æœåŠ¡æœªå“åº”'"
        timeout 6h tail -f tunnel.log
