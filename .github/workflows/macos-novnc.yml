name: macOS noVNC
on: workflow_dispatch

jobs:
  deploy:
    runs-on: macos-14

    steps:
    - name: Install Node.js alternative
      run: |
        # 安装 Node.js
        brew install node
        
        # 安装 node-websockify
        npm install -g node-websockify
        
        # 下载 noVNC
        git clone https://github.com/novnc/noVNC.git ~/noVNC
        
        echo "Node.js 方案安装完成"

    - name: Enable VNC and start proxy
      run: |
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw asdf1234 \
          -restart -agent -privs -all
        
        sleep 15
        
        # 使用 node-websockify
        node-websockify --web ~/noVNC 6080 localhost:5900 &
        
        echo "代理服务已启动"

    - name: Start tunnel
      run: |
        curl -L https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-darwin-arm64.tgz -o cloudflared.tgz
        tar -xzf cloudflared.tgz
        chmod +x cloudflared
        
        ./cloudflared tunnel --url http://localhost:6080 2>&1 | tee tunnel.log &
        sleep 45

    - name: Run
      run: |
        echo "macOS noVNC (Node.js 版)"
        echo "密码: asdf1234"
        timeout 6h tail -f tunnel.log
