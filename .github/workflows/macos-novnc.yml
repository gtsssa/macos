name: macOS noVNC
on: workflow_dispatch

jobs:
  deploy:
    runs-on: macos-14
    timeout-minutes: 360

    steps:
    - name: Download and extract all dependencies
      run: |
        # åˆ›å»ºç›®å½•
        mkdir -p ~/novnc-setup
        cd ~/novnc-setup
        
        # 1. ä¸‹è½½ noVNC æœ€æ–°ç‰ˆ
        wget -O novnc.tar.gz https://github.com/novnc/noVNC/archive/refs/tags/v1.4.0.tar.gz
        tar -xzf novnc.tar.gz
        mv noVNC-1.4.0 noVNC
        
        # 2. ä¸‹è½½ websockify äºŒè¿›åˆ¶ï¼ˆGoè¯­è¨€ç¼–è¯‘çš„ç‹¬ç«‹ç‰ˆæœ¬ï¼‰
        wget -O websockify https://github.com/novnc/websockify-js/releases/download/v0.10.0/websockify
        chmod +x websockify
        
        # 3. ä¸‹è½½ websockify-jsï¼ˆJavaScriptç‰ˆæœ¬ï¼‰
        wget -O websockify-js.tar.gz https://github.com/novnc/websockify-js/archive/refs/tags/v0.10.0.tar.gz
        tar -xzf websockify-js.tar.gz
        mv websockify-js-0.10.0 websockify-js
        
        echo "âœ… æ‰€æœ‰æ–‡ä»¶ä¸‹è½½å®Œæˆ"

    - name: Enable macOS VNC service
      run: |
        # å¯ç”¨ macOS åŸç”Ÿ VNC
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw asdf1234 \
          -restart -agent -privs -all
        
        echo "ç­‰å¾… VNC æœåŠ¡å¯åŠ¨..."
        sleep 15
        
        # éªŒè¯ VNC æœåŠ¡
        if lsof -i :5900 > /dev/null 2>&1; then
          echo "âœ… VNC æœåŠ¡è¿è¡Œæ­£å¸¸ (ç«¯å£ 5900)"
        else
          echo "âš ï¸  VNC ç«¯å£æœªç›‘å¬ï¼Œå°è¯•é‡å¯..."
          # é‡å¯æœåŠ¡
          sudo launchctl unload /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          sleep 10
        fi

    - name: Start noVNC proxy using Node.js
      run: |
        cd ~/novnc-setup
        
        # åˆ›å»ºç®€å•çš„ Node.js ä»£ç†æœåŠ¡å™¨
        cat > server.js << 'EOF'
const http = require('http');
const WebSocket = require('ws');
const fs = require('fs');
const path = require('path');

const VNC_HOST = 'localhost';
const VNC_PORT = 5900;
const HTTP_PORT = 6080;
const WEB_ROOT = path.join(__dirname, 'noVNC');

// åˆ›å»º HTTP æœåŠ¡å™¨
const server = http.createServer((req, res) => {
  let filePath = path.join(WEB_ROOT, req.url === '/' ? 'vnc.html' : req.url);
  
  // é»˜è®¤é¡µé¢
  if (req.url === '/') {
    filePath = path.join(WEB_ROOT, 'vnc.html');
  }
  
  // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  fs.readFile(filePath, (err, content) => {
    if (err) {
      if (err.code === 'ENOENT') {
        // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å› 404
        res.writeHead(404);
        res.end('File not found');
      } else {
        // æœåŠ¡å™¨é”™è¯¯
        res.writeHead(500);
        res.end('Server error');
      }
    } else {
      // æˆåŠŸè¿”å›æ–‡ä»¶
      const ext = path.extname(filePath);
      let contentType = 'text/html';
      
      if (ext === '.js') contentType = 'text/javascript';
      else if (ext === '.css') contentType = 'text/css';
      else if (ext === '.png') contentType = 'image/png';
      else if (ext === '.jpg' || ext === '.jpeg') contentType = 'image/jpeg';
      
      res.writeHead(200, { 'Content-Type': contentType });
      res.end(content);
    }
  });
});

// WebSocket ä»£ç†
const wss = new WebSocket.Server({ noServer: true });

wss.on('connection', (clientWs) => {
  console.log('noVNC client connected');
  
  // è¿æ¥åˆ° VNC æœåŠ¡å™¨
  const vncWs = new WebSocket(`ws://${VNC_HOST}:${VNC_PORT}`);
  
  clientWs.on('message', (data) => {
    if (vncWs.readyState === WebSocket.OPEN) {
      vncWs.send(data);
    }
  });
  
  vncWs.on('message', (data) => {
    if (clientWs.readyState === WebSocket.OPEN) {
      clientWs.send(data);
    }
  });
  
  vncWs.on('close', () => {
    console.log('VNC connection closed');
    clientWs.close();
  });
  
  clientWs.on('close', () => {
    console.log('noVNC client disconnected');
    vncWs.close();
  });
  
  vncWs.on('error', (err) => {
    console.error('VNC WebSocket error:', err.message);
    clientWs.close();
  });
});

// å¤„ç† WebSocket å‡çº§
server.on('upgrade', (request, socket, head) => {
  wss.handleUpgrade(request, socket, head, (ws) => {
    wss.emit('connection', ws, request);
  });
});

// å¯åŠ¨æœåŠ¡å™¨
server.listen(HTTP_PORT, () => {
  console.log(`noVNC server running on http://localhost:${HTTP_PORT}`);
  console.log(`Web root: ${WEB_ROOT}`);
  console.log(`Proxying to VNC at ${VNC_HOST}:${VNC_PORT}`);
});

// ä¼˜é›…å…³é—­
process.on('SIGINT', () => {
  console.log('Shutting down server...');
  server.close();
  process.exit(0);
});
EOF
        
        # ç¡®ä¿æœ‰ Node.js
        brew install node || true
        
        # å®‰è£… ws æ¨¡å—
        npm install ws || echo "npm å¯èƒ½å·²å®‰è£… ws"
        
        # å¯åŠ¨æœåŠ¡å™¨
        node server.js > ~/novnc.log 2>&1 &
        NOVNC_PID=$!
        echo $NOVNC_PID > ~/novnc.pid
        
        echo "ç­‰å¾… noVNC æœåŠ¡å™¨å¯åŠ¨..."
        sleep 10
        
        # éªŒè¯æœåŠ¡
        echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€:"
        if curl -s http://localhost:6080 > /dev/null; then
          echo "âœ… noVNC HTTP æœåŠ¡æ­£å¸¸"
        else
          echo "âŒ noVNC HTTP æœåŠ¡å¼‚å¸¸"
          tail -20 ~/novnc.log
        fi
        
        if lsof -i :6080 > /dev/null; then
          echo "âœ… noVNC ç«¯å£ 6080 ç›‘å¬æ­£å¸¸"
        else
          echo "âŒ noVNC ç«¯å£æœªç›‘å¬"
        fi

    - name: Setup Cloudflared tunnel
      run: |
        # ä¸‹è½½ cloudflared
        curl -L https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-darwin-arm64.tgz -o cloudflared.tgz
        tar -xzf cloudflared.tgz
        chmod +x cloudflared
        mv cloudflared /usr/local/bin/cloudflared 2>/dev/null || sudo mv cloudflared /usr/local/bin/
        
        # å¯åŠ¨éš§é“
        cloudflared tunnel --url http://localhost:6080 > ~/tunnel.log 2>&1 &
        sleep 50
        
        echo "éš§é“ä¿¡æ¯:"
        echo "================"
        
        # ç­‰å¾…å¹¶æ˜¾ç¤º URL
        for i in {1..8}; do
          if grep -q "trycloudflare.com" ~/tunnel.log; then
            TUNNEL_URL=$(grep -o 'https://[^ ]*\.trycloudflare\.com' ~/tunnel.log | head -1)
            echo "âœ… noVNC è®¿é—®åœ°å€: $TUNNEL_URL"
            echo "ğŸ”‘ VNC å¯†ç : asdf1234"
            echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
            break
          fi
          echo "ç­‰å¾…éš§é“å»ºç«‹... ($i/8)"
          sleep 5
        done
        
        if [ -z "${{ env.TUNNEL_URL }}" ]; then
          echo "âš ï¸  æœªèƒ½è·å–éš§é“ URLï¼ŒæŸ¥çœ‹æ—¥å¿—:"
          tail -30 ~/tunnel.log
        fi

    - name: Display connection information
      run: |
        echo "========================================"
        echo "     ğŸ–¥ï¸  macOS noVNC æ¡Œé¢ç¯å¢ƒ"
        echo "========================================"
        echo ""
        
        if [ -n "${{ env.TUNNEL_URL }}" ]; then
          echo "ğŸŒ åœ¨çº¿è®¿é—®: ${{ env.TUNNEL_URL }}"
          echo "   æˆ–: ${{ env.TUNNEL_URL }}/vnc.html"
        else
          echo "ğŸŒ æœ¬åœ°è®¿é—®: http://localhost:6080/vnc.html"
        fi
        
        echo ""
        echo "ğŸ”‘ è¿æ¥å¯†ç : asdf1234"
        echo ""
        echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
        echo "- VNC æœåŠ¡: localhost:5900 $(lsof -i :5900 > /dev/null && echo 'âœ…' || echo 'âŒ')"
        echo "- noVNC ä»£ç†: localhost:6080 $(lsof -i :6080 > /dev/null && echo 'âœ…' || echo 'âŒ')"
        echo "- Cloudflared: $(pgrep -f cloudflared > /dev/null && echo 'âœ…' || echo 'âŒ')"
        echo ""
        echo "ğŸ”§ è°ƒè¯•ä¿¡æ¯:"
        echo "  æŸ¥çœ‹ noVNC æ—¥å¿—: tail -f ~/novnc.log"
        echo "  æŸ¥çœ‹éš§é“æ—¥å¿—: tail -f ~/tunnel.log"
        echo ""
        echo "========================================"

    - name: Monitor and keep alive
      run: |
        echo "ç›‘æ§æœåŠ¡è¿è¡ŒçŠ¶æ€..."
        echo "æŒ‰ Ctrl+C æˆ–å–æ¶ˆå·¥ä½œæµä»¥åœæ­¢"
        echo ""
        
        # æ˜¾ç¤ºå®æ—¶æ—¥å¿—
        tail -f ~/tunnel.log &
        TUNNEL_TAIL_PID=$!
        
        tail -f ~/novnc.log &
        NOVNC_TAIL_PID=$!
        
        # ç›‘æ§å¾ªç¯
        COUNTER=0
        while [ $COUNTER -lt 360 ]; do  # 6å°æ—¶
          echo ""
          echo "[$(date '+%H:%M:%S')] æœåŠ¡æ£€æŸ¥:"
          
          # æ£€æŸ¥è¿›ç¨‹
          if [ -f ~/novnc.pid ] && kill -0 $(cat ~/novnc.pid) 2>/dev/null; then
            echo "  noVNC æœåŠ¡å™¨: âœ… è¿è¡Œä¸­"
          else
            echo "  noVNC æœåŠ¡å™¨: âŒ å·²åœæ­¢"
          fi
          
          if pgrep -f "cloudflared tunnel" > /dev/null; then
            echo "  Cloudflared: âœ… è¿è¡Œä¸­"
          else
            echo "  Cloudflared: âŒ å·²åœæ­¢"
          fi
          
          # æ£€æŸ¥ç«¯å£
          echo "  ç«¯å£çŠ¶æ€:"
          echo "    - 5900 (VNC): $(lsof -i :5900 > /dev/null && echo 'ç›‘å¬' || echo 'å…³é—­')"
          echo "    - 6080 (noVNC): $(lsof -i :6080 > /dev/null && echo 'ç›‘å¬' || echo 'å…³é—­')"
          
          sleep 60
          COUNTER=$((COUNTER + 1))
        done
        
        # æ¸…ç†
        kill $TUNNEL_TAIL_PID 2>/dev/null || true
        kill $NOVNC_TAIL_PID 2>/dev/null || true

    - name: Cleanup
      if: always()
      run: |
        echo "æ¸…ç†è¿›ç¨‹..."
        
        # åœæ­¢ noVNC æœåŠ¡å™¨
        if [ -f ~/novnc.pid ]; then
          kill $(cat ~/novnc.pid) 2>/dev/null || true
          rm -f ~/novnc.pid
        fi
        
        # åœæ­¢ cloudflared
        pkill -f "cloudflared tunnel" 2>/dev/null || true
        
        # åœæ­¢ VNC æœåŠ¡
        sudo launchctl unload /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
        
        echo "æ¸…ç†å®Œæˆ"
