name: macOS noVNC Docker
on: workflow_dispatch

jobs:
  deploy:
    runs-on: macos-14

    steps:
    - name: Install Docker and run container
      run: |
        # å®‰è£… Docker
        brew install docker
        brew install --cask docker
        
        # å¯åŠ¨ Docker æœåŠ¡
        sudo launchctl load /Library/LaunchDaemons/com.docker.vmnetd.plist
        open -a Docker --background
        
        echo "ç­‰å¾… Docker å¯åŠ¨..."
        sleep 30
        
        # è¿è¡Œ noVNC å®¹å™¨ï¼ˆä½¿ç”¨æ”¯æŒ macOS çš„é•œåƒï¼‰
        # æ³¨æ„ï¼šmacOS æ˜¯ ARM æ¶æ„ï¼Œéœ€è¦ ARM é•œåƒ
        docker run -d \
          --name novnc \
          -p 6080:8080 \
          -p 5900:5900 \
          -e VNC_PW=asdf1234 \
          -e VNC_RESOLUTION=1024x768 \
          lscr.io/linuxserver/webtop:ubuntu-xfce
        
        echo "å®¹å™¨å·²å¯åŠ¨"
        docker ps

    - name: Setup tunnel
      run: |
        curl -L https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-darwin-arm64.tgz -o cloudflared.tgz
        tar -xzf cloudflared.tgz
        chmod +x cloudflared
        
        ./cloudflared tunnel --url http://localhost:6080 2>&1 | tee tunnel.log &
        sleep 60
        
        echo "ç­‰å¾…éš§é“å»ºç«‹..."

    - name: Display info
      run: |
        echo "========================================"
        echo "     macOS noVNC via Docker"
        echo "========================================"
        echo ""
        echo "ğŸ”‘ å¯†ç : asdf1234"
        echo "ğŸŒ æœ¬åœ°è®¿é—®: http://localhost:6080"
        echo ""
        echo "æŸ¥çœ‹ tunnel.log è·å– Cloudflare URL"
        echo ""
        timeout 6h tail -f tunnel.log
