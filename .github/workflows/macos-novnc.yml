name: macOS noVNC via Docker
on: workflow_dispatch

jobs:
  deploy:
    runs-on: macos-14
    timeout-minutes: 360 # è¿è¡Œ6å°æ—¶

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker and run noVNC container
      run: |
        # æ‹‰å–ä¸€ä¸ªé›†æˆäº†æ¡Œé¢ç¯å¢ƒå’ŒnoVNCçš„Dockeré•œåƒï¼ˆç¤ºä¾‹ä¸ºUbuntu XFCEï¼‰
        # æ³¨æ„ï¼šGitHub Actionsçš„macOS runneræ˜¯ARMæ¶æ„ï¼Œéœ€è¦ç¡®è®¤é•œåƒæ”¯æŒ
        docker run -d \
          --name mac-desktop \
          -p 6080:80 \
          -p 5900:5900 \
          -e VNC_PASSWORD=asdf1234 \
          -e RESOLUTION=1280x720 \
          --shm-size=1g \
          dorowu/ubuntu-desktop-lxde-vnc:arm64 # æ³¨æ„å¯»æ‰¾æ”¯æŒARM64çš„æ ‡ç­¾
        sleep 15
        echo "Dockerå®¹å™¨å·²å¯åŠ¨ï¼Œç­‰å¾…æœåŠ¡å°±ç»ª..."

    - name: Download and start Cloudflared tunnel
      run: |
        # ä¸‹è½½macOSç‰ˆçš„cloudflared
        curl -L https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-darwin-arm64.tgz -o cloudflared.tgz
        tar -xzf cloudflared.tgz
        chmod +x cloudflared
        # å¯åŠ¨éš§é“ï¼ŒæŒ‡å‘å®¹å™¨å†…éƒ¨çš„noVNCæœåŠ¡ï¼ˆç«¯å£6080ï¼‰
        ./cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
        sleep 30
        echo "éš§é“å¯åŠ¨æ—¥å¿—ï¼š"
        grep -o 'https://[^ ]*\.trycloudflare\.com' tunnel.log | head -1 || echo "URLç”Ÿæˆä¸­ï¼Œè¯·æŸ¥çœ‹tunnel.log"

    - name: Keep alive and display info
      run: |
        echo "========================================"
        echo "     macOS noVNC æ¡Œé¢ç¯å¢ƒå·²å¯åŠ¨"
        echo "========================================"
        echo "ğŸ”‘ VNCå¯†ç ï¼šasdf1234"
        echo "ğŸŒ è¯·æŸ¥çœ‹ä¸Šä¸€æ­¥è¾“å‡ºçš„Cloudflareéš§é“URL"
        echo "ğŸ“ æœ¬åœ°ç›´æ¥è®¿é—®ï¼ˆä»…è°ƒè¯•ï¼‰ï¼šhttp://localhost:6080"
        echo "========================================"
        # ä¿æŒå·¥ä½œæµè¿è¡Œ
        timeout 355m tail -f tunnel.log
