name: macOS noVNC Colima
on: workflow_dispatch

jobs:
  deploy:
    runs-on: macos-14

    steps:
    - name: Install Colima and run container
      run: |
        # å®‰è£… colimaï¼ˆmacOS ä¸Šçš„è½»é‡çº§ Dockerï¼‰
        brew install colima
        brew install docker
        
        # å¯åŠ¨ colima
        colima start --cpu 2 --memory 4 --disk 20
        
        echo "ç­‰å¾… colima å¯åŠ¨..."
        sleep 30
        
        # è¿è¡Œ noVNC å®¹å™¨
        docker run -d \
          --name novnc-desktop \
          -p 6080:80 \
          -p 5900:5900 \
          -e VNC_PASSWORD=asdf1234 \
          -e RESOLUTION=1280x720 \
          dorowu/ubuntu-desktop-lxde-vnc
        
        echo "å®¹å™¨è¿è¡Œä¸­..."
        docker ps

    - name: Setup tunnel
      run: |
        curl -L https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-darwin-arm64.tgz -o cloudflared.tgz
        tar -xzf cloudflared.tgz
        chmod +x cloudflared
        
        ./cloudflared tunnel --url http://localhost:6080 2>&1 | tee tunnel.log &
        sleep 45
        
        grep 'trycloudflare.com' tunnel.log && echo "URLå·²ç”Ÿæˆ"

    - name: Run
      run: |
        echo "âœ… Docker noVNC æ¡Œé¢"
        echo "ğŸ”‘ å¯†ç : asdf1234"
        timeout 6h tail -f tunnel.log
